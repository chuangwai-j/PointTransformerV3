# æ¨¡å‹é…ç½®ï¼šæ‰€æœ‰å‚æ•°åã€æ ¼å¼ä¸ PointTransformerV3.__init__ å®Œå…¨å¯¹é½
model:
  type: PT-v3m1                # æ­£ç¡®ï¼šä¸æ¨¡å‹æ³¨å†Œå @MODELS.register_module('PT-v3m1') ä¸€è‡´
  in_channels: 9               # æ­£ç¡®ï¼šä½ çš„9ç»´è¾“å…¥ç‰¹å¾ï¼ˆu/v/BeamAz + é‚»åŸŸå‡å€¼/æ ‡å‡†å·®ï¼‰
  num_classes: 5               # æ­£ç¡®ï¼šé£åˆ‡å˜äºŒåˆ†ç±»ï¼ˆæœ‰/æ— é£åˆ‡å˜ï¼‰
  cls_mode: False              # å¿…éœ€ï¼šFalse=åˆ†å‰²/æ£€æµ‹æ¨¡å¼ï¼ˆä¿ç•™è§£ç å™¨ï¼‰ï¼ŒTrue=åˆ†ç±»æ¨¡å¼ï¼ˆæ— è§£ç å™¨ï¼‰ï¼Œé£åˆ‡å˜æ£€æµ‹éœ€è®¾ä¸ºFalse
  order: ["z", "z-trans"]      # å¿…éœ€ï¼šæ¨¡å‹é»˜è®¤çš„ç‚¹äº‘åºåˆ—åŒ–é¡ºåºï¼Œä¸ __init__ é»˜è®¤å€¼ä¸€è‡´
  pdnorm_bn: False             # å¿…éœ€ï¼šå…³é—­å¤šæ•°æ®é›†é€‚é…çš„PDNormï¼ˆå•æ•°æ®é›†æ— éœ€ï¼‰
  pdnorm_ln: False             # å¿…éœ€ï¼šåŒä¸Šï¼Œå…³é—­PDNormï¼Œä½¿ç”¨æ™®é€šLayerNorm/BatchNorm

  # -------------------------- ç¼–ç å™¨å‚æ•°ï¼ˆé•¿åº¦å‡ä¸º4ï¼Œå¯¹åº”4ä¸ªç¼–ç å™¨é˜¶æ®µï¼‰ --------------------------
  # 1. ä¿®æ­£å‚æ•°åï¼šenc_depth â†’ enc_depthsï¼ˆå¤æ•°ï¼‰ï¼Œæ ¼å¼ä¸ºåˆ—è¡¨ï¼ˆå¯¹åº”ç¼–ç å™¨å„é˜¶æ®µæ·±åº¦ï¼‰
  enc_depths: [1, 1, 3, 1]     # æ­£ç¡®ï¼šç¼–ç å™¨4ä¸ªé˜¶æ®µçš„Blockæ•°é‡ï¼Œé•¿åº¦=N
  # 2. ä¿®æ­£å‚æ•°æ ¼å¼ï¼šenc_channels éœ€ä¸ºåˆ—è¡¨ï¼ˆå¯¹åº”ç¼–ç å™¨å„é˜¶æ®µé€šé“æ•°ï¼‰ï¼Œé•¿åº¦=N
  enc_channels: [32, 64, 128, 256]  # æ­£ç¡®ï¼šä¸ enc_depths é•¿åº¦ä¸€è‡´ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªé˜¶æ®µçš„ç‰¹å¾é€šé“æ•°
  # 3. ä¿®æ­£å‚æ•°æ ¼å¼ï¼šenc_num_head éœ€ä¸ºåˆ—è¡¨ï¼ˆå¯¹åº”ç¼–ç å™¨å„é˜¶æ®µæ³¨æ„åŠ›å¤´æ•°ï¼‰ï¼Œé•¿åº¦=N
  enc_num_head: [2, 4, 8, 16]  # æ­£ç¡®ï¼šä¸ enc_depths é•¿åº¦ä¸€è‡´ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªé˜¶æ®µçš„æ³¨æ„åŠ›å¤´æ•°ï¼ˆéœ€æ»¡è¶³ enc_channels[s] % enc_num_head[s] == 0ï¼‰
  # 4. è¡¥å……ç¼ºå¤±å¿…éœ€å‚æ•°ï¼šstrideï¼ˆæ± åŒ–æ­¥é•¿ï¼‰ï¼Œé•¿åº¦=N-1ï¼ˆenc_depthsé•¿åº¦-1ï¼‰
  stride: [2, 2, 2]            # æ­£ç¡®ï¼šç¼–ç å™¨ç¬¬2-4é˜¶æ®µçš„æ± åŒ–æ­¥é•¿ï¼Œé•¿åº¦=4-1=3
  # 5. è¡¥å……ç¼ºå¤±å¿…éœ€å‚æ•°ï¼šenc_patch_sizeï¼ˆç¼–ç å™¨æ³¨æ„åŠ›patchå¤§å°ï¼‰ï¼Œé•¿åº¦=N
  enc_patch_size: [48, 48, 48, 48]  # æ­£ç¡®ï¼šä¸ enc_depths é•¿åº¦ä¸€è‡´ï¼ˆ4ï¼‰ï¼Œæ¯ä¸ªé˜¶æ®µçš„æ³¨æ„åŠ›patchå¤§å°

  # -------------------------- è§£ç å™¨å‚æ•°ï¼ˆé•¿åº¦å‡ä¸º3ï¼Œå¯¹åº” N-1=3ä¸ªè§£ç å™¨é˜¶æ®µï¼‰ --------------------------
  # cls_mode=Falseæ—¶å¿…éœ€ï¼Œé•¿åº¦éœ€=ç¼–ç å™¨é˜¶æ®µæ•°-1=3
  dec_depths: [1, 1, 1]        # æ­£ç¡®ï¼šè§£ç å™¨3ä¸ªé˜¶æ®µçš„Blockæ•°é‡ï¼Œé•¿åº¦=4-1=3
  dec_channels: [64, 64, 128]  # æ­£ç¡®ï¼šè§£ç å™¨å„é˜¶æ®µé€šé“æ•°ï¼Œé•¿åº¦=4-1=3
  dec_num_head: [4, 4, 8]      # æ­£ç¡®ï¼šè§£ç å™¨å„é˜¶æ®µæ³¨æ„åŠ›å¤´æ•°ï¼Œé•¿åº¦=4-1=3
  dec_patch_size: [48, 48, 48] # æ­£ç¡®ï¼šè§£ç å™¨å„é˜¶æ®µpatchå¤§å°ï¼Œé•¿åº¦=4-1=3

  # -------------------------- æ¨¡å‹é»˜è®¤å‚æ•°ï¼ˆå¯é€‰ï¼Œå·²ä¼˜åŒ–ï¼‰ --------------------------
  mlp_ratio: 4                  # é»˜è®¤ï¼šMLPéšè—å±‚é€šé“æ•°å€æ•°ï¼ˆenc_channels[s] * mlp_ratioï¼‰
  qkv_bias: True                # é»˜è®¤ï¼šæ³¨æ„åŠ›QKVæ˜¯å¦åŠ åç½®
  drop_path: 0.5                # é»˜è®¤ï¼šDropPathæ¦‚ç‡ï¼ˆé˜²æ­¢è¿‡æ‹Ÿåˆï¼‰
  enable_flash: False           # å»ºè®®ï¼šè‹¥æœªå®‰è£…flash_attnï¼Œè®¾ä¸ºFalseï¼ˆé¿å…å¯¼å…¥é”™è¯¯ï¼‰

# æ•°æ®é…ç½®
data:
  train:
    type: WindShearDataset  # ä½¿ç”¨æ‚¨çš„é£åˆ‡å˜æ•°æ®é›†
    split: train
    data_root: "/mnt/d/model/wind_datas/csv_labels"
    filter_full_paths:  # å…³é”®ï¼šå¡«å†™ä½ç‚¹æ•°æ ·æœ¬çš„å®Œæ•´è·¯å¾„ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”
      - "/mnt/d/model/wind_datas/csv_labels/20230310/datas4/period107_labeled.csv"
      - "/mnt/d/model/wind_datas/csv_labels/20230319/datas1/nn217_labeled.csv"
      - "/mnt/d/model/wind_datas/csv_labels/20230314/datas1/aa217_labeled.csv"
      - "/mnt/d/model/wind_datas/csv_labels/20230317/datas1/gg1_labeled.csv"
      - "/mnt/d/model/wind_datas/csv_labels/20230308/datas1/i1_labeled.csv"
      - "/mnt/d/model/wind_datas/csv_labels/20230310/datas1/period110_labeled.csv"
    k_neighbors: 16  # é‚»åŸŸç‚¹æ•°
    radius: 100.0      # é‚»åŸŸåŠå¾„
    transform:
      - type: NormalizeWind  # é£é€Ÿæ ‡å‡†åŒ–
        u_mean: -0.7983   # æ›¿æ¢ä¸ºçœŸå®uå‡å€¼
        u_std: 2.6732     # æ›¿æ¢ä¸ºçœŸå®uæ ‡å‡†å·®
        v_mean: 2.0401    # æ›¿æ¢ä¸ºçœŸå®vå‡å€¼
        v_std: 3.1915     # æ›¿æ¢ä¸ºçœŸå®væ ‡å‡†å·®
        beamaz_mean: 184.0494  # æ›¿æ¢ä¸ºçœŸå®beamazå‡å€¼
        beamaz_std: 100.2158   # æ›¿æ¢ä¸ºçœŸå®beamazæ ‡å‡†å·®
      - type: WindShearGridSample     # ç½‘æ ¼é‡‡æ ·
        grid_size: [122.6, 118.0, 5.4]
        min_points: 50
        adaptive: False
      - type: ToTensor       # è½¬æ¢ä¸ºå¼ é‡

  val:
    type: WindShearDataset
    split: val
    data_root: "/mnt/d/model/wind_datas/csv_labels"
    k_neighbors: 16
    radius: 100.0
    transform:
      - type: NormalizeWind
        u_mean: -0.7983   # æ›¿æ¢ä¸ºçœŸå®uå‡å€¼
        u_std: 2.6732     # æ›¿æ¢ä¸ºçœŸå®uæ ‡å‡†å·®
        v_mean: 2.0401    # æ›¿æ¢ä¸ºçœŸå®vå‡å€¼
        v_std: 3.1915     # æ›¿æ¢ä¸ºçœŸå®væ ‡å‡†å·®
        beamaz_mean: 184.0494  # æ›¿æ¢ä¸ºçœŸå®beamazå‡å€¼
        beamaz_std: 100.2158   # æ›¿æ¢ä¸ºçœŸå®beamazæ ‡å‡†å·®
      - type: WindShearGridSample
        grid_size: [122.6, 118.0, 5.4]
        min_points: 50
        adaptive: False
      - type: ToTensor

  test:
    type: WindShearDataset
    split: test
    data_root: "/mnt/d/model/wind_datas/csv_labels"
    k_neighbors: 16
    radius: 100.0
    transform:
      - type: NormalizeWind
        u_mean: -0.7983   # æ›¿æ¢ä¸ºçœŸå®uå‡å€¼
        u_std: 2.6732     # æ›¿æ¢ä¸ºçœŸå®uæ ‡å‡†å·®
        v_mean: 2.0401    # æ›¿æ¢ä¸ºçœŸå®vå‡å€¼
        v_std: 3.1915     # æ›¿æ¢ä¸ºçœŸå®væ ‡å‡†å·®
        beamaz_mean: 184.0494  # æ›¿æ¢ä¸ºçœŸå®beamazå‡å€¼
        beamaz_std: 100.2158   # æ›¿æ¢ä¸ºçœŸå®beamazæ ‡å‡†å·®
      - type: WindShearGridSample
        grid_size: [122.6, 118.0, 5.4]
        min_points: 50
        adaptive: False
      - type: ToTensor

# è®­ç»ƒé…ç½®
train:
  epochs: 60
  batch_size: 2  # ğŸŒŸ ç§»å›è¿™é‡Œï¼šè®­ç»ƒé›†DataLoaderçš„batch_size
  num_workers: 8  # ğŸŒŸ ç§»å›è¿™é‡Œï¼šè®­ç»ƒé›†DataLoaderçš„çº¿ç¨‹æ•°
  prefetch_factor: 8   # ğŸŒŸ é¢„å–æ‰¹æ¬¡ä»é»˜è®¤2æå‡åˆ°4
  pin_memory: True     # ğŸŒŸ å¯ç”¨å›ºå®šå†…å­˜ï¼ŒåŠ é€ŸCPUâ†’GPUä¼ è¾“
  optimizer:
    type: AdamW
    lr: 0.00015
    weight_decay: 0.001
  scheduler:
    type: CosineAnnealingLR
    T_max: 100
    eta_min: 0.00001
  two_stage: true
  class_weights: [ 0.8, 0.1, 1.0, 4.5, 2.5 ]   # ä¸ä¹‹å‰ä¸€è‡´
  stage_epochs: [ 100, 30 ]                     # é˜¶æ®µ1/2 è½®æ•°

# éªŒè¯é…ç½®ï¼ˆæ–°å¢ï¼Œä¸“é—¨ç”¨äº val é˜¶æ®µï¼‰
evaluation:
  interval: 1  # æ¯1ä¸ªepochè¯„ä¼°ä¸€æ¬¡
  batch_size: 2  # ğŸŒŸ éªŒè¯é›†DataLoaderçš„batch_sizeï¼ˆä¸è®­ç»ƒä¸€è‡´ï¼‰
  num_workers: 8  # ğŸŒŸ éªŒè¯é›†DataLoaderçš„çº¿ç¨‹æ•°ï¼ˆä¸è®­ç»ƒä¸€è‡´ï¼‰
  prefetch_factor: 8   # ğŸŒŸ ä¸è®­ç»ƒä¸€è‡´
  pin_memory: True     # ğŸŒŸ ä¸è®­ç»ƒä¸€è‡´

# æµ‹è¯•é…ç½®ï¼ˆæ–°å¢ï¼Œä¸“é—¨ç”¨äº test é˜¶æ®µï¼‰
test:
  batch_size: 2  # æµ‹è¯•æ‰¹æ¬¡å¤§å°ï¼ˆå¯ç‹¬ç«‹è®¾ç½®ï¼Œå¦‚æ¯”éªŒè¯å¤§ï¼Œå……åˆ†åˆ©ç”¨GPUï¼‰
  num_workers: 8  # æµ‹è¯•çº¿ç¨‹æ•°ï¼ˆå¯ä¸éªŒè¯ä¸åŒï¼‰
  prefetch_factor: 8  # æµ‹è¯•é¢„å–æ‰¹æ¬¡
  pin_memory: True  # æµ‹è¯•CPUâ†’GPUä¼ è¾“åŠ é€Ÿ

checkpoint:
  interval: 5  # æ¯5ä¸ªepochä¿å­˜ä¸€æ¬¡æ£€æŸ¥ç‚¹

log:
  interval: 50  # è®°å½•æ—¥å¿—